listeners:
  httpbin:
    listen: 0.0.0.0:15006
    protocol:
      name: http
      props:
    pipelines:
      - name: capybara.pipelines.http.lua
        props:
          content: |
            function handle_request_headers(ctx,headers)
              local u = headers:get('x-upstream-key')
              if u ~= nil and u ~= '' then
                ctx:set_upstream(u)
              else
                ctx:respond({
                  status=502,
                  headers={
                    ['Content-Type']='application/json; charset=UTF-8'
                  },
                  body=json:encode({err='NO_ROUTE_FOUND',msg='Please set x-upstream-key!'})
                })
              end
            end

            function handle_status_line(ctx,status_line)
              ctx:replace_header('X-Powered-By','capybara')
            end

upstreams:
  httpbin:
    transport: tcp
    resolver: default
    balancer: round-robin
    endpoints:
      - addr: httpbin.org:80
        weight: 50
      - addr: httpbingo.org:80
        weight: 50
